openapi: 3.0.0
info:
  title: API HyperFresh
  description: API complète respectant les standards REST (GET, POST, PUT, DELETE) et les codes d'erreurs.
  version: 3.0.0
servers:
  - url: http://localhost:3000/api/v1

# Sécurisation globale (JWT)
security:
  - bearerAuth: []

tags:
  - name: Auth
    description: Authentification
  - name: Products
    description: Gestion du stock
  - name: Paniers
    description: Gestion des offres commerciales
  - name: Orders
    description: Commandes et Retraits

paths:
  # --- 1. AUTHENTIFICATION ---
  /auth/login:
    post:
      tags: [Auth]
      security: [] # Public endpoint
      summary: Se connecter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthInput'
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Email ou mot de passe incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # --- 2. GESTION PRODUITS (CRUD) ---
  /products:
    get:
      tags: [Products]
      summary: Lister les produits
      responses:
        '200':
          description: Succès
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Product'
    
    post:
      tags: [Products]
      summary: Créer un produit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductInput'
      responses:
        '201':
          description: Produit créé
        '400':
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /products/{id}:
    put:
      tags: [Products]
      summary: Mettre à jour un produit
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductInput'
      responses:
        '200':
          description: Produit mis à jour
        '404':
          description: Produit introuvable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # --- 3. GESTION PANIERS (CRUD) ---
  /paniers:
    get:
      tags: [Paniers]
      summary: Rechercher des paniers (Filtres)
      parameters:
        - in: query
          name: ville
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
            enum: [disponible, reserve]
      responses:
        '200':
          description: Liste des paniers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Panier'
    
    post:
      tags: [Paniers]
      summary: Mettre un panier en vente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PanierInput'
      responses:
        '201':
          description: Panier créé

  /paniers/{id}:
    get:
      tags: [Paniers]
      summary: Voir le détail d'un panier
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Panier trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Panier'
        '404':
          description: Panier inexistant

    delete:
      tags: [Paniers]
      summary: Supprimer un panier 
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Panier supprimé avec succès
        '403':
          description: Interdit 

  # --- 4. COMMANDES ---
  /orders:
    post:
      tags: [Orders]
      summary: Créer une commande 
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderInput'
      responses:
        '201':
          description: Commande validée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          description: Panier déjà vendu ou indisponible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /orders/{id}/status:
    put:
      tags: [Orders]
      summary: Mettre à jour le statut
      description: Utilisé par le magasin quand l'étudiant vient chercher son panier.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [COLLECTED]
      responses:
        '200':
          description: Statut mis à jour
        '404':
          description: Commande introuvable

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- OBJET ERREUR STANDARD ---
    Error:
      type: object
      properties:
        code:
          type: integer
          example: 404
        message:
          type: string
          example: "Ressource introuvable"

    # --- INPUTS & OUTPUTS METIERS ---
    AuthInput:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    AuthResponse:
      type: object
      properties:
        token:
          type: string
        role:
          type: string

    Product:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        original_price:
          type: number
        barcode:
          type: string

    ProductInput:
      type: object
      required: [name, original_price]
      properties:
        name:
          type: string
        original_price:
          type: number
        barcode:
          type: string

    Panier:
      type: object
      properties:
        id:
          type: integer
        titre:
          type: string
        price:
          type: number
        status:
          type: string
          enum: [disponible, reserve, vendu]
        items:
          type: array
          items:
            type: integer 

    PanierInput:
      type: object
      required: [titre, price, product_ids]
      properties:
        titre:
          type: string
        price:
          type: number
        product_ids:
          type: array
          items:
            type: integer

    Order:
      type: object
      properties:
        id:
          type: integer
        status:
          type: string
        pickup_code:
          type: string
        panier_id:
          type: integer
        user_id:
          type: integer

    OrderInput:
      type: object
      required: [panier_id]
      properties:
        panier_id:
          type: integer
